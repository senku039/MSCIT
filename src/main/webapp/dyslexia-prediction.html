<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dyslexia Prediction Test</title>
  <link rel="stylesheet" href="/theme.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      padding: 18px;
      background: linear-gradient(180deg, #F9FAFB 0%, #E5E7EB 100%);
      color: #0f172a;
    }

    .quest-wrap { max-width: 1080px; margin: 16px auto 32px; }

    .quest-header {
      text-align: center;
      padding: 22px;
      border-radius: 16px;
      border: 1px solid #dbe4f0;
      background: #ffffff;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      margin-bottom: 14px;
    }

    .quest-header h1 { color: #2563EB; font-weight: 800; }
    .quest-header p { color: #334155; }

    .tip-box {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid #cceeea;
      background: #effcf9;
      color: #0f766e;
      padding: 9px 12px;
      font-size: .94rem;
    }

    .map-shell {
      position: relative;
      padding: 18px 10px 14px;
      border-radius: 20px;
      background: transparent;
      border: none;
      box-shadow: none;
    }

    .road-line {
      position: absolute;
      inset: 38px 0 56px;
      width: 100%;
      height: calc(100% - 94px);
      z-index: 1;
      pointer-events: none;
    }

    .runner {
      position: absolute;
      z-index: 3;
      width: 54px;
      height: 54px;
      left: calc(50% - 27px);
      top: 66px;
      background: url('https://cdn-icons-png.flaticon.com/512/1864/1864493.png') center/contain no-repeat;
      filter: drop-shadow(0 7px 12px rgba(0,0,0,.28));
      animation: runRoad 16s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes runRoad {
      0% { transform: translate(0,0); }
      14% { transform: translate(0,95px); }
      28% { transform: translate(-300px,185px); }
      42% { transform: translate(-280px,315px); }
      56% { transform: translate(300px,410px); }
      70% { transform: translate(280px,540px); }
      84% { transform: translate(0,665px); }
      100% { transform: translate(0,760px); }
    }

    .level-list {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      gap: 18px;
      padding: 6px 4px 0;
    }

    .level-card {
      width: 46%;
      position: relative;
      padding: 18px;
      border-radius: 16px;
      border: 1px solid #dbe4f0;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.08);
      transition: all .3s ease;
      color: #0f172a;
      background: #fff;
    }

    .level-card:nth-child(odd) { margin-right: auto; }
    .level-card:nth-child(even) { margin-left: auto; }
    .level-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
    }

    .level-card::after {
      content: "";
      position: absolute;
      top: 50%;
      width: 80px;
      height: 4px;
      background: #cbd5e1;
      border-radius: 999px;
      box-shadow: none;
    }
    .level-card:nth-child(odd)::after { right: -80px; }
    .level-card:nth-child(even)::after { left: -80px; }

    .level-badge {
      display: inline-block;
      margin-bottom: 7px;
      border-radius: 999px;
      padding: 4px 11px;
      font-size: .76rem;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(120deg, #2563EB, #14B8A6);
    }

    .level-title { font-weight: 700; margin-bottom: 8px; color: #0f172a; }

    .level-card .form-control {
      border-radius: 999px;
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #cbd5e1;
      margin-bottom: 8px;
    }

    .level-card.active {
      border-color: #2563EB;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.18), 0 14px 28px rgba(15, 23, 42, 0.12);
    }

    .level-card.completed {
      border-color: #16A34A;
      background: #f0fdf4;
    }

    .level-card.completed .level-badge {
      background: linear-gradient(120deg, #16A34A, #22c55e);
    }

    .level-card.locked {
      opacity: 0.7;
    }

    .final-card {
      width: 84%;
      margin: 8px auto 0;
      background: #fff;
      border-color: #dbe4f0;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.1);
    }
    .final-card::after { display: none; }

    .goal-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .finish-pill {
      border-radius: 999px;
      background: #ecfdf5;
      border: 1px solid #86efac;
      color: #166534;
      padding: 4px 10px;
      font-size: .78rem;
      font-weight: 700;
    }

    .btn {
      border-radius: 999px;
      border: none;
      transition: all .3s ease;
    }

    .btn:hover {
      transform: scale(1.03);
    }

    .btn-primary,
    .btn-success {
      background: linear-gradient(120deg, #2563EB, #14B8A6);
      box-shadow: 0 10px 16px rgba(37, 99, 235, 0.25);
    }

    .btn-light {
      background: linear-gradient(120deg, #f8fafc, #e2e8f0);
      color: #0f172a !important;
      border: 1px solid #cbd5e1;
    }

    #result { margin-top: 10px; }

    @media (max-width: 960px) {
      .road-line, .runner { display: none; }
      .level-card, .final-card { width: 100%; margin: 0; border-radius: 16px; }
      .level-card::after { display: none; }
    }
  </style>
</head>
<body>
  <button class="global-back-btn" type="button" onclick="window.location.href='/home'">‚Üê Back</button>

  <div class="quest-wrap">
    <div class="quest-header">
      <h1 class="mb-2">Dyslexia Roadmap Game</h1>
      <p class="mb-1">Move level by level on the roadmap and unlock your final prediction checkpoint.</p>
      <div class="tip-box" id="randomTip"></div>
    </div>

    <div class="map-shell">
      <svg class="road-line" viewBox="0 0 1000 1200" preserveAspectRatio="none" aria-hidden="true">
        <defs>
          <linearGradient id="curveRoad" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#d1d5db"/>
            <stop offset="100%" stop-color="#9ca3af"/>
          </linearGradient>
        </defs>
        <path d="M500 20
                 V150
                 Q500 185 465 185
                 H230
                 Q195 185 195 220
                 V315
                 Q195 350 230 350
                 H770
                 Q805 350 805 385
                 V480
                 Q805 515 770 515
                 H230
                 Q195 515 195 550
                 V645
                 Q195 680 230 680
                 H770
                 Q805 680 805 715
                 V810
                 Q805 845 770 845
                 H500
                 V1060"
              fill="none" stroke="url(#curveRoad)" stroke-width="18" stroke-linecap="round" stroke-linejoin="round" opacity="0.95"/>
        <path d="M500 20
                 V150
                 Q500 185 465 185
                 H230
                 Q195 185 195 220
                 V315
                 Q195 350 230 350
                 H770
                 Q805 350 805 385
                 V480
                 Q805 515 770 515
                 H230
                 Q195 515 195 550
                 V645
                 Q195 680 230 680
                 H770
                 Q805 680 805 715
                 V810
                 Q805 845 770 845
                 H500
                 V1060"
              fill="none" stroke="#f8fafc" stroke-width="4" stroke-dasharray="12 14" stroke-linecap="round" stroke-linejoin="round" opacity="0.95"/>
      </svg>
      <div class="runner" aria-hidden="true"></div>

      <div class="level-list">
        <div class="level-card active" data-input="attention"><span class="level-badge">Level 1</span><div class="level-title">Attention Span</div><input type="number" id="attention" class="form-control" placeholder="Enter attention span score" disabled><button class="btn btn-primary w-100" id="takeAttentionTest">Play Level</button></div>
        <div class="level-card locked" data-input="cognitive"><span class="level-badge">Level 2</span><div class="level-title">Cognitive Score</div><input type="number" id="cognitive" class="form-control" placeholder="Enter cognitive score" disabled><button class="btn btn-primary w-100" id="takeCognitiveTest">Play Level</button></div>
        <div class="level-card locked" data-input="reading_speed"><span class="level-badge">Level 3</span><div class="level-title">Reading Speed</div><input type="number" id="reading_speed" class="form-control" placeholder="Enter reading speed" disabled><button class="btn btn-primary w-100" id="takeReadingSpeedTest">Play Level</button></div>
        <div class="level-card locked" data-input="spelling_accuracy"><span class="level-badge">Level 4</span><div class="level-title">Spelling Accuracy</div><input type="number" id="spelling_accuracy" class="form-control" placeholder="Enter spelling accuracy" disabled><button class="btn btn-primary w-100" id="takeSpellingAccuracyTest">Play Level</button></div>
        <div class="level-card locked" data-input="writing_errors"><span class="level-badge">Level 5</span><div class="level-title">Writing Errors</div><input type="number" id="writing_errors" class="form-control" placeholder="Enter writing errors" disabled><button class="btn btn-primary w-100" id="takeWritingErrorsTest">Play Level</button></div>
        <div class="level-card locked" data-input="phonemic_errors"><span class="level-badge">Level 6</span><div class="level-title">Phonemic Awareness Errors</div><input type="number" id="phonemic_errors" class="form-control" placeholder="Enter phonemic awareness errors" disabled><button class="btn btn-primary w-100" id="takePhonemicErrorsTest">Play Level</button></div>

        <div class="level-card final-card locked" data-input="response_time">
          <div class="goal-title">
            <span class="level-badge">Final Level</span>
            <span class="finish-pill">üèÅ Check Result</span>
          </div>
          <div class="level-title">Response Time + Predict</div>
          <input type="number" id="response_time" class="form-control" placeholder="Enter response time" disabled>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-light text-dark" id="takeResponseTimeTest">Play Level</button>
            <button id="submitBtn" class="btn btn-success flex-grow-1">Reach Goal & Predict</button>
          </div>
          <div id="result"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.onload = function() {
      const tests = ["attention", "cognitive", "reading_speed", "spelling_accuracy", "writing_errors", "phonemic_errors", "response_time"];
      tests.forEach(test => {
        const value = sessionStorage.getItem(test + "_score");
        if (value) document.getElementById(test).value = value;
      });

      const cards = Array.from(document.querySelectorAll('.level-card[data-input]'));
      let activeAssigned = false;
      cards.forEach((card) => {
        const inputId = card.dataset.input;
        const hasScore = Boolean(sessionStorage.getItem(inputId + '_score'));
        card.classList.remove('completed', 'active', 'locked');
        if (hasScore) {
          card.classList.add('completed');
        } else if (!activeAssigned) {
          card.classList.add('active');
          activeAssigned = true;
        } else {
          card.classList.add('locked');
        }
      });

      const tips = [
        "Tip: Follow the roadmap from Level 1 to the final checkpoint.",
        "Tip: Randomized mini-levels improve screening quality.",
        "Tip: Complete all levels in one session for best consistency."
      ];
      document.getElementById('randomTip').textContent = tips[Math.floor(Math.random() * tips.length)];
    };

    document.getElementById('takeAttentionTest').addEventListener('click', () => { window.location.href = "/attention_span_calculator.html"; });
    document.getElementById('takeCognitiveTest').addEventListener('click', () => { window.location.href = "/cognitive_score_test.html"; });
    document.getElementById('takeReadingSpeedTest').addEventListener('click', () => { window.location.href = "/reading_speed_test.html"; });
    document.getElementById('takeSpellingAccuracyTest').addEventListener('click', () => { window.location.href = "/spelling_accuracy_test.html"; });
    document.getElementById('takeWritingErrorsTest').addEventListener('click', () => { window.location.href = "/writing_errors_test.html"; });
    document.getElementById('takePhonemicErrorsTest').addEventListener('click', () => { window.location.href = "/phonemic_awareness_test.html"; });
    document.getElementById('takeResponseTimeTest').addEventListener('click', () => { window.location.href = "/response_time_test.html"; });

    document.getElementById('submitBtn').addEventListener('click', function() {
      const inputData = {
        Attention_Span: document.getElementById('attention').value,
        Cognitive_Score: document.getElementById('cognitive').value,
        Reading_Speed: document.getElementById('reading_speed').value,
        Spelling_Accuracy: document.getElementById('spelling_accuracy').value,
        Writing_Errors: document.getElementById('writing_errors').value,
        Phonemic_Awareness_Errors: document.getElementById('phonemic_errors').value,
        Response_Time: document.getElementById('response_time').value
      };

      fetch('http://127.0.0.1:5000/predict', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(inputData)
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.prediction !== undefined) {
          const predictionScore = Number(data.prediction);
          const resultText = predictionScore >= 0.5 ? "High likelihood of dyslexia" : "Low likelihood of dyslexia";
          const redirectPath = data.result_redirect || '';
          if (redirectPath) {
            window.location.href = `http://127.0.0.1:5000${redirectPath}`;
            return;
          }
          document.getElementById('result').innerHTML = `<div class="alert alert-info mt-2">${resultText} (${(predictionScore*100).toFixed(2)}%)</div>`;
        } else {
          document.getElementById('result').innerHTML = `<div class="alert alert-danger mt-2">‚ùå Error: ${data.error || 'No prediction returned'}</div>`;
        }
      })
      .catch(error => {
        document.getElementById('result').innerHTML = `<div class="alert alert-danger mt-2">‚ùå Error: ${error.message}</div>`;
      });
    });
  </script>
</body>
</html>
