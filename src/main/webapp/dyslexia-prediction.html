<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dyslexia Prediction Test</title>
  <link rel="stylesheet" href="/theme.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-a: #f8fbff;
      --bg-b: #e9f2ff;
      --primary: #2563eb;
      --primary-2: #14b8a6;
      --success: #16a34a;
      --warning: #f59e0b;
      --muted: #94a3b8;
      --card: #ffffff;
      --ink: #0f172a;
    }

    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      padding: 18px;
      background:
        radial-gradient(circle at 12% 18%, rgba(37, 99, 235, 0.16), transparent 38%),
        radial-gradient(circle at 90% 10%, rgba(20, 184, 166, 0.15), transparent 34%),
        radial-gradient(circle at 52% 58%, rgba(250, 204, 21, 0.1), transparent 40%),
        repeating-linear-gradient(45deg, rgba(148, 163, 184, 0.06) 0, rgba(148, 163, 184, 0.06) 2px, transparent 2px, transparent 12px),
        linear-gradient(180deg, var(--bg-a) 0%, var(--bg-b) 100%);
      color: var(--ink);
    }


    body::before,
    body::after {
      content: "";
      position: fixed;
      top: 120px;
      width: 240px;
      height: 76vh;
      pointer-events: none;
      z-index: 0;
      border-radius: 24px;
      opacity: .55;
    }

    body::before {
      left: 10px;
      background:
        radial-gradient(circle at 18px 18px, rgba(37,99,235,.24) 3px, transparent 4px) 0 0/34px 34px,
        linear-gradient(180deg, rgba(37,99,235,.08), rgba(20,184,166,.08));
    }

    body::after {
      right: 10px;
      background:
        radial-gradient(circle at 18px 18px, rgba(20,184,166,.24) 3px, transparent 4px) 0 0/34px 34px,
        linear-gradient(180deg, rgba(20,184,166,.08), rgba(37,99,235,.08));
    }

    .quest-wrap { position: relative; z-index: 2; max-width: 1280px; margin: 16px auto 32px; }

    .quest-header {
      text-align: center;
      padding: 24px;
      border-radius: 18px;
      border: 1px solid #dbe7ff;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.1);
      margin-bottom: 16px;
    }

    .quest-header h1 {
      color: var(--primary);
      font-weight: 800;
      letter-spacing: -.3px;
    }

    .quest-header p { color: #334155; }

    .tip-box {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid #b8ece4;
      background: #f0fdfa;
      color: #0f766e;
      padding: 10px 12px;
      font-size: .93rem;
      font-weight: 600;
    }

    .progress-pill {
      margin: 8px auto 0;
      width: fit-content;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1d4ed8;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: .82rem;
      font-weight: 700;
    }

    .map-shell {
      position: relative;
      padding: 18px 10px 14px;
      border-radius: 20px;
      background: transparent;
    }

    .road-line {
      position: absolute;
      inset: 38px 0 56px;
      width: 100%;
      height: calc(100% - 94px);
      z-index: 1;
      pointer-events: none;
    }

    .runner {
      font-size: 42px;
      position: absolute;
      z-index: 6;
      width: 62px;
      height: 62px;
      left: calc(50% - 31px);
      top: 58px;
      display: grid;
      place-items: center;
      font-size: 42px;
      line-height: 1;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.95), rgba(219,234,254,.85));
      border: 2px solid rgba(59, 130, 246, 0.35);
      box-shadow: 0 12px 18px rgba(15, 23, 42, 0.2);
      transition: transform .9s cubic-bezier(.2,.9,.35,1), opacity .3s ease;
      pointer-events: none;
      opacity: 0.98;
    }


    .level-list {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      gap: 18px;
      padding: 6px 4px 0;
    }

    .level-card {
      width: 46%;
      position: relative;
      padding: 18px;
      border-radius: 18px;
      border: 1px solid #dbe4f0;
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.09);
      transition: transform .3s ease, box-shadow .3s ease, opacity .3s ease;
      color: var(--ink);
      background: var(--card);
      overflow: hidden;
    }

    .level-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(37,99,235,.07), rgba(20,184,166,.05));
      pointer-events: none;
    }

    .level-card > * { position: relative; z-index: 1; }

    .level-card:nth-child(odd) { margin-right: auto; }
    .level-card:nth-child(even) { margin-left: auto; }

    .level-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 18px 34px rgba(15, 23, 42, 0.13);
    }

    .level-card::after {
      content: "";
      position: absolute;
      top: 50%;
      width: 84px;
      height: 4px;
      background: #cbd5e1;
      border-radius: 999px;
    }

    .level-card:nth-child(odd)::after { right: -84px; }
    .level-card:nth-child(even)::after { left: -84px; }

    .level-badge {
      display: inline-block;
      margin-bottom: 8px;
      border-radius: 999px;
      padding: 4px 12px;
      font-size: .76rem;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(120deg, var(--primary), var(--primary-2));
    }

    .level-title { font-weight: 700; margin-bottom: 8px; color: var(--ink); }

    .priority-chip {
      display: inline-block;
      margin-left: 8px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: .68rem;
      font-weight: 700;
      background: #eef2ff;
      color: #4338ca;
      border: 1px solid #c7d2fe;
      vertical-align: middle;
    }

    .level-card .form-control {
      border-radius: 999px;
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #cbd5e1;
      margin-bottom: 8px;
    }

    .level-card.active {
      border-color: #60a5fa;
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.16), 0 16px 32px rgba(15, 23, 42, 0.14);
    }

    .level-card.completed {
      border-color: #86efac;
      background: #f0fdf4;
    }

    .level-card.completed .level-badge {
      background: linear-gradient(120deg, #16A34A, #22c55e);
    }

    .level-card.locked {
      opacity: 0.62;
      filter: grayscale(0.1);
    }

    .level-card.locked .btn {
      pointer-events: none;
      opacity: 0.65;
    }

    .final-card {
      width: 84%;
      margin: 8px auto 0;
      background: #fff;
      border-color: #dbe4f0;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.1);
    }
    .final-card::after { display: none; }


    .goal-card {
      width: 58%;
      margin: 10px auto 0;
      border: 1px solid #bfdbfe;
      background: linear-gradient(120deg, rgba(239,246,255,.95), rgba(236,253,245,.95));
      box-shadow: 0 12px 24px rgba(37,99,235,.12);
    }

    .goal-card::after {
      display: none;
    }

    .goal-card .goal-heading {
      font-size: 1.05rem;
      font-weight: 800;
      color: #1d4ed8;
      margin-bottom: 8px;
    }

    .goal-card .goal-subtext {
      color: #334155;
      font-size: .88rem;
      margin-bottom: 10px;
    }


    .goal-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .finish-pill {
      border-radius: 999px;
      background: #fffbeb;
      border: 1px solid #fcd34d;
      color: #92400e;
      padding: 4px 10px;
      font-size: .78rem;
      font-weight: 700;
    }

    .btn {
      border-radius: 999px;
      border: none;
      transition: all .3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(255,255,255,.28), transparent 45%);
      opacity: 0;
      transition: opacity .3s ease;
    }

    .btn:hover { transform: scale(1.03); }
    .btn:hover::before { opacity: 1; }

    .btn-primary,
    .btn-success {
      background: linear-gradient(120deg, var(--primary), var(--primary-2));
      box-shadow: 0 10px 18px rgba(37, 99, 235, 0.24);
    }

    .btn-light {
      background: linear-gradient(120deg, #f8fafc, #e2e8f0);
      color: #0f172a !important;
      border: 1px solid #cbd5e1;
    }

    #result { margin-top: 10px; }

    @media (max-width: 960px) {
      .road-line, .runner {
      font-size: 42px; display: none; }
      .level-card, .final-card, .goal-card { width: 100%; margin: 0; border-radius: 16px; }
      .level-card::after { display: none; }
    }
  </style>
</head>
<body>
  <button class="global-back-btn" type="button" onclick="window.location.href='index.html'">‚Üê Back</button>

  <div class="quest-wrap">
    <div class="quest-header">
      <h1 class="mb-2">Dyslexia Roadmap Game</h1>
      <p class="mb-1">Complete one level at a time and unlock the final prediction checkpoint.</p>
      <div class="progress-pill" id="progressPill">Progress: 0 / 7 levels completed</div>
      <div class="tip-box" id="randomTip"></div>
    </div>

    <div class="map-shell">
      <svg class="road-line" viewBox="0 0 1000 1200" preserveAspectRatio="none" aria-hidden="true">
        <defs>
          <linearGradient id="curveRoad" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#d1d5db"/>
            <stop offset="100%" stop-color="#94a3b8"/>
          </linearGradient>
        </defs>
        <path id="roadPath" d="M500 20 V150 Q500 185 465 185 H230 Q195 185 195 220 V315 Q195 350 230 350 H770 Q805 350 805 385 V480 Q805 515 770 515 H230 Q195 515 195 550 V645 Q195 680 230 680 H770 Q805 680 805 715 V810 Q805 845 770 845 H500 V1060"
              fill="none" stroke="url(#curveRoad)" stroke-width="18" stroke-linecap="round" stroke-linejoin="round" opacity="0.95"/>
        <path d="M500 20 V150 Q500 185 465 185 H230 Q195 185 195 220 V315 Q195 350 230 350 H770 Q805 350 805 385 V480 Q805 515 770 515 H230 Q195 515 195 550 V645 Q195 680 230 680 H770 Q805 680 805 715 V810 Q805 845 770 845 H500 V1060"
              fill="none" stroke="#f8fafc" stroke-width="4" stroke-dasharray="12 14" stroke-linecap="round" stroke-linejoin="round" opacity="0.95"/>
      </svg>
      <div class="runner" aria-hidden="true" id="runner" title="Roadmap hen">üêî</div>

      <div class="level-list">
        <div class="level-card active" data-input="reading_speed"><span class="level-badge">Level 1</span><div class="level-title">Reading Speed <span class="priority-chip">High Priority</span></div><input type="number" id="reading_speed" class="form-control" placeholder="Enter reading speed" disabled><button class="btn btn-primary w-100" id="takeReadingSpeedTest">Play Level</button></div>
        <div class="level-card locked" data-input="attention"><span class="level-badge">Level 2</span><div class="level-title">Rapid Naming <span class="priority-chip">High Priority</span></div><input type="number" id="attention" class="form-control" placeholder="Enter rapid naming score" disabled><button class="btn btn-primary w-100" id="takeAttentionTest">Play Level</button></div>
        <div class="level-card locked" data-input="spelling_accuracy"><span class="level-badge">Level 3</span><div class="level-title">Spelling Accuracy <span class="priority-chip">High Priority</span></div><input type="number" id="spelling_accuracy" class="form-control" placeholder="Enter spelling accuracy" disabled><button class="btn btn-primary w-100" id="takeSpellingAccuracyTest">Play Level</button></div>
        <div class="level-card locked" data-input="phonemic_errors"><span class="level-badge">Level 4</span><div class="level-title">Phonemic Awareness Errors <span class="priority-chip">High Priority</span></div><input type="number" id="phonemic_errors" class="form-control" placeholder="Enter phonemic awareness errors" disabled><button class="btn btn-primary w-100" id="takePhonemicErrorsTest">Play Level</button></div>
        <div class="level-card locked" data-input="writing_errors"><span class="level-badge">Level 5</span><div class="level-title">Writing Errors <span class="priority-chip">Medium</span></div><input type="number" id="writing_errors" class="form-control" placeholder="Enter writing errors" disabled><button class="btn btn-primary w-100" id="takeWritingErrorsTest">Play Level</button></div>
        <div class="level-card locked" data-input="cognitive"><span class="level-badge">Level 6</span><div class="level-title">Cognitive Score <span class="priority-chip">Medium</span></div><input type="number" id="cognitive" class="form-control" placeholder="Enter cognitive score" disabled><button class="btn btn-primary w-100" id="takeCognitiveTest">Play Level</button></div>

        <div class="level-card final-card locked" data-input="response_time">
          <div class="goal-title">
            <span class="level-badge">Final Level</span>
            <span class="finish-pill">üèÅ Unlock Goal</span>
          </div>
          <div class="level-title">Response Time Checkpoint</div>
          <input type="number" id="response_time" class="form-control" placeholder="Enter response time" disabled>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-light text-dark w-100" id="takeResponseTimeTest">Play Level</button>
          </div>
        </div>

        <div class="level-card goal-card locked" id="goalCard">
          <div class="goal-heading">üèÜ Reach Goal & Predict</div>
          <div class="goal-subtext">Complete all 7 levels to unlock your final prediction result.</div>
          <button id="submitBtn" class="btn btn-success w-100">Reach Goal & Predict</button>
          <div id="result"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = `${window.location.protocol}//127.0.0.1:5000`;
    const LEVEL_KEYS = ["reading_speed", "attention", "spelling_accuracy", "phonemic_errors", "writing_errors", "cognitive", "response_time"];
    const LEVEL_ROUTES = {
      reading_speed: "/reading_speed_test.html",
      spelling_accuracy: "/spelling_accuracy_test.html",
      phonemic_errors: "/phonemic_awareness_test.html",
      writing_errors: "/writing_errors_test.html",
      cognitive: "/cognitive_score_test.html",
      attention: "/rapid_naming_test.html",
      response_time: "/response_time_test.html"
    };



    function moveRunnerToCard(card) {
      const runner = document.getElementById('runner');
      const mapShell = document.querySelector('.map-shell');
      const roadPath = document.getElementById('roadPath');
      if (!runner || !mapShell || !card || !roadPath) return;

      const mapRect = mapShell.getBoundingClientRect();
      const cardRect = card.getBoundingClientRect();
      const targetCardX = cardRect.left + (cardRect.width / 2) - mapRect.left;
      const targetCardY = cardRect.top + (cardRect.height / 2) - mapRect.top;

      const pathLength = roadPath.getTotalLength();
      let bestPoint = roadPath.getPointAtLength(0);
      let bestDistance = Number.POSITIVE_INFINITY;
      const samples = 320;

      for (let i = 0; i <= samples; i++) {
        const point = roadPath.getPointAtLength((i / samples) * pathLength);
        const dx = point.x - targetCardX;
        const dy = point.y - targetCardY;
        const distance = (dx * dx) + (dy * dy);
        if (distance < bestDistance) {
          bestDistance = distance;
          bestPoint = point;
        }
      }

      const targetX = bestPoint.x - 31;
      const targetY = bestPoint.y - 31;
      runner.style.transform = `translate(${Math.round(targetX)}px, ${Math.round(targetY)}px)`;
    }

    function getCompletionState() {
      return LEVEL_KEYS.map((key) => Boolean(sessionStorage.getItem(`${key}_score`)));
    }

    function updateProgressUI() {
      LEVEL_KEYS.forEach((test) => {
        const value = sessionStorage.getItem(test + "_score");
        const inputEl = document.getElementById(test);
        if (value && inputEl) inputEl.value = value;
      });

      const completedState = getCompletionState();
      const completedCount = completedState.filter(Boolean).length;
      const cards = Array.from(document.querySelectorAll('.level-card[data-input]'));

      let activeAssigned = false;
      cards.forEach((card) => {
        const inputId = card.dataset.input;
        const index = LEVEL_KEYS.indexOf(inputId);
        const hasScore = completedState[index];

        card.classList.remove('completed', 'active', 'locked');
        const levelButton = card.querySelector('button');

        if (hasScore) {
          card.classList.add('completed');
          if (levelButton) levelButton.disabled = false;
        } else if (!activeAssigned) {
          card.classList.add('active');
          activeAssigned = true;
          if (levelButton) levelButton.disabled = false;
        } else {
          card.classList.add('locked');
          if (levelButton) levelButton.disabled = true;
        }
      });

      const progressEl = document.getElementById('progressPill');
      progressEl.textContent = `Progress: ${completedCount} / ${LEVEL_KEYS.length} levels completed`;

      const activeOrLastCompleted = cards.find((card) => card.classList.contains('active')) || cards[cards.length - 1];
      moveRunnerToCard(activeOrLastCompleted);

      const goalCard = document.getElementById('goalCard');
      goalCard.classList.remove('active', 'completed', 'locked');
      if (completedCount >= LEVEL_KEYS.length) {
        goalCard.classList.add('active');
      } else {
        goalCard.classList.add('locked');
      }

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = completedCount < LEVEL_KEYS.length;
      submitBtn.title = completedCount < LEVEL_KEYS.length ? 'Complete all levels first' : 'Submit for prediction';
    }

    function goToLevel(levelKey) {
      const cards = Array.from(document.querySelectorAll('.level-card[data-input]'));
      const card = cards.find((el) => el.dataset.input === levelKey);
      if (!card || card.classList.contains('locked')) {
        return;
      }
      window.location.href = `${API_BASE}${LEVEL_ROUTES[levelKey]}`;
    }

    window.onload = function() {
      const tips = [
        "Tip: You can unlock only one next level at a time.",
        "Tip: Complete all seven levels for the most reliable screen.",
        "Tip: Follow the bird guide as you complete each level."
      ];
      document.getElementById('randomTip').textContent = tips[Math.floor(Math.random() * tips.length)];
      requestAnimationFrame(() => updateProgressUI());
    };

    window.addEventListener('resize', updateProgressUI);

    document.getElementById('takeReadingSpeedTest').addEventListener('click', () => goToLevel('reading_speed'));
    document.getElementById('takeSpellingAccuracyTest').addEventListener('click', () => goToLevel('spelling_accuracy'));
    document.getElementById('takePhonemicErrorsTest').addEventListener('click', () => goToLevel('phonemic_errors'));
    document.getElementById('takeWritingErrorsTest').addEventListener('click', () => goToLevel('writing_errors'));
    document.getElementById('takeCognitiveTest').addEventListener('click', () => goToLevel('cognitive'));
    document.getElementById('takeAttentionTest').addEventListener('click', () => goToLevel('attention'));
    document.getElementById('takeResponseTimeTest').addEventListener('click', () => goToLevel('response_time'));

    function toNum(key, fallback = 0) {
      const value = Number(sessionStorage.getItem(key));
      return Number.isFinite(value) ? value : fallback;
    }

    function clamp01(v) { return Math.max(0, Math.min(1, v)); }
    function inv01(v) { return 1 - clamp01(v); }
    function normHigher(v, min, max) { return clamp01((v - min) / Math.max(max - min, 1e-6)); }
    function normLower(v, min, max) { return inv01(normHigher(v, min, max)); }

    function encodePayload(payload) {
      const raw = JSON.stringify(payload);
      return btoa(unescape(encodeURIComponent(raw))).replace(/\+/g, '-').replace(/\//g, '_');
    }

    function computeCentralEvaluation() {
      const readingSpeed = toNum('reading_speed_score', toNum('reading_speed', 0));
      const rapidNaming = toNum('attention_score', toNum('attention_score', toNum('attention', 0)));
      const rapidNamingAccuracy = toNum('rapid_naming_accuracy', 75);
      const phonemicErrors = toNum('phonemic_errors_score', toNum('phonemic_awareness_errors_score', toNum('phonemic_errors', 0)));
      const spelling = toNum('spelling_accuracy_score', toNum('spelling_accuracy', 0));
      const writingErrors = toNum('writing_errors_score', toNum('writing_errors', 0));
      const cognitive = toNum('cognitive_score', toNum('cognitive', 0));
      const responseTime = toNum('response_time_score', toNum('response_time', 1.0));
      const comprehension = toNum('reading_comprehension_accuracy', 70);

      const facePresence = toNum('face_presence_time', 0);
      const lookingAway = toNum('looking_away_seconds', 0);
      const eyeMovement = toNum('eye_movement_index', 0);
      const attentionStability = toNum('attention_stability', 70);
      const movementVariability = toNum('movement_variability', eyeMovement);
      const cameraReliability = toNum('camera_reliability', toNum('tracking_quality', 60));

      // High-priority reading indicators (50%).
      const readingComponent = (
        inv01(normHigher(readingSpeed, 70, 220)) * 0.35 +
        inv01(normHigher(comprehension, 50, 100)) * 0.20 +
        inv01(normHigher(rapidNaming, 40, 100)) * 0.20 +
        normHigher(phonemicErrors, 0, 5) * 0.20 +
        normHigher(eyeMovement, 0, 100) * 0.05
      );

      // Language indicators (30%).
      const languageComponent = (
        inv01(normHigher(spelling, 60, 100)) * 0.6 +
        normHigher(writingErrors, 0, 5) * 0.4
      );

      // Cognitive indicators (15%).
      const cognitiveComponent = inv01(normHigher(cognitive, 40, 100));

      // Support indicators (5%).
      const supportComponent = (
        normHigher(responseTime, 0.2, 2.2) * 0.55 +
        inv01(normHigher(cameraReliability, 35, 100)) * 0.45
      );

      const finalRisk01 = clamp01((readingComponent * 0.50) + (languageComponent * 0.30) + (cognitiveComponent * 0.15) + (supportComponent * 0.05));
      const riskScore = Math.round(finalRisk01 * 100);
      const riskLevel = riskScore <= 30 ? 'Low Risk' : (riskScore <= 60 ? 'Moderate Risk' : 'High Risk');

      const completeness = [
        'reading_speed_score','attention_score','spelling_accuracy_score','phonemic_errors_score','writing_errors_score','cognitive_score','response_time_score'
      ].map((k) => sessionStorage.getItem(k) !== null).filter(Boolean).length / 7;
      const cameraQuality = clamp01(cameraReliability / 100);
      const consistencySpread = Math.max(readingComponent, languageComponent, cognitiveComponent, supportComponent) - Math.min(readingComponent, languageComponent, cognitiveComponent, supportComponent);
      const consistency = clamp01(1 - consistencySpread);
      const confidenceValue = clamp01((completeness * 0.5) + (cameraQuality * 0.2) + (consistency * 0.3));
      const confidenceLevel = confidenceValue >= 0.75 ? 'High' : (confidenceValue >= 0.5 ? 'Medium' : 'Low');

      const indicators = [
        { name: 'Reading fluency', value: inv01(normHigher(readingSpeed, 70, 220)) },
        { name: 'Rapid naming', value: inv01(normHigher(rapidNaming, 40, 100)) },
        { name: 'Phonemic awareness', value: normHigher(phonemicErrors, 0, 5) },
        { name: 'Spelling pattern', value: inv01(normHigher(spelling, 60, 100)) },
        { name: 'Writing errors', value: normHigher(writingErrors, 0, 5) },
        { name: 'Attention stability', value: inv01(normHigher(attentionStability, 40, 100)) },
        { name: 'Response-time support', value: normHigher(responseTime, 0.2, 2.2) },
        { name: 'Movement variability', value: normHigher(movementVariability, 0, 120) },
        { name: 'Camera reliability', value: inv01(normHigher(cameraReliability, 35, 100)) }
      ].sort((a, b) => b.value - a.value).slice(0, 4).map((x) => x.name);

      const testBreakdown = [
        { test: 'Reading Speed + Comprehension', score: Number(readingSpeed.toFixed(2)), normalized_risk: Number((inv01(normHigher(readingSpeed, 70, 220)) * 100).toFixed(2)), analysis: `WPM=${readingSpeed.toFixed(1)}, comprehension=${comprehension.toFixed(0)}%, face_presence=${facePresence.toFixed(0)}s` },
        { test: 'Rapid Naming', score: Number(rapidNaming.toFixed(2)), normalized_risk: Number((inv01(normHigher(rapidNaming, 40, 100)) * 100).toFixed(2)), analysis: `accuracy=${rapidNamingAccuracy.toFixed(1)}%, speed-score=${rapidNaming.toFixed(1)}` },
        { test: 'Spelling Accuracy', score: Number(spelling.toFixed(2)), normalized_risk: Number((inv01(normHigher(spelling, 60, 100)) * 100).toFixed(2)), analysis: `spelling accuracy=${spelling.toFixed(1)}%` },
        { test: 'Phonemic Awareness Errors', score: Number(phonemicErrors.toFixed(2)), normalized_risk: Number((normHigher(phonemicErrors, 0, 5) * 100).toFixed(2)), analysis: `error count=${phonemicErrors.toFixed(1)} (lower is better)` },
        { test: 'Writing Errors', score: Number(writingErrors.toFixed(2)), normalized_risk: Number((normHigher(writingErrors, 0, 5) * 100).toFixed(2)), analysis: `writing error score=${writingErrors.toFixed(1)} (lower is better)` },
        { test: 'Cognitive Score', score: Number(cognitive.toFixed(2)), normalized_risk: Number((inv01(normHigher(cognitive, 40, 100)) * 100).toFixed(2)), analysis: `cognitive score=${cognitive.toFixed(1)}%` },
      ];

      const recommendationText = riskLevel === 'High Risk'
        ? 'Your pattern shows stronger reading-language difficulty signals. A supportive specialist review can help plan next steps.'
        : (riskLevel === 'Moderate Risk'
          ? 'Your pattern shows some reading/language difficulty signals. Regular practice and follow-up screening are recommended.'
          : 'Your current pattern suggests lower risk. Keep regular reading practice and monitor progress over time.');

      const personalRecommendation = `Focus first on: ${indicators.slice(0, 2).join(' and ')}. Practice 10-15 minutes daily with guided tasks in these areas.`;

      const finalPayload = {
        prediction: Number((riskScore / 100).toFixed(4)),
        probability_percent: riskScore,
        model_probability: Number((riskScore / 100).toFixed(4)),
        model_probability_percent: riskScore,
        risk_level: riskLevel,
        summary: recommendationText,
        observations: indicators.map((i) => `${i} contributed to the final screening profile.`),
        recommendations: [
          'This is a behavioral screening result, not a medical diagnosis.',
          'Use reading, language, and classroom observations together for next steps.',
          recommendationText,
          personalRecommendation,
        ],
        feature_analysis: [
          { feature: 'Reading Component (High Priority)', value: Number((readingComponent * 100).toFixed(2)), expected_range: '0-100 risk', status: 'Computed', impact: 'Primary signal', abnormal: readingComponent > 0.6 },
          { feature: 'Language Component', value: Number((languageComponent * 100).toFixed(2)), expected_range: '0-100 risk', status: 'Computed', impact: 'Secondary signal', abnormal: languageComponent > 0.6 },
          { feature: 'Cognitive Component', value: Number((cognitiveComponent * 100).toFixed(2)), expected_range: '0-100 risk', status: 'Computed', impact: 'Supportive signal', abnormal: cognitiveComponent > 0.6 },
          { feature: 'Support Component', value: Number((supportComponent * 100).toFixed(2)), expected_range: '0-100 risk', status: 'Computed', impact: 'Quality signal', abnormal: supportComponent > 0.7 }
        ],
        dyslexia_risk_score: riskScore,
        dyslexia_risk_level: riskLevel,
        confidence_level: confidenceLevel,
        dominant_indicators: indicators,
        recommendation_text: `${recommendationText} ${personalRecommendation}`,
        attention_stability: Number(attentionStability.toFixed(2)),
        movement_variability: Number(movementVariability.toFixed(2)),
        camera_reliability: Number(cameraReliability.toFixed(2)),
        component_scores: {
          reading_component: Number((readingComponent * 100).toFixed(2)),
          language_component: Number((languageComponent * 100).toFixed(2)),
          cognitive_component: Number((cognitiveComponent * 100).toFixed(2)),
          support_component: Number((supportComponent * 100).toFixed(2)),
        },
        test_breakdown: testBreakdown,
      };

      sessionStorage.setItem('dyslexia_risk_score', String(finalPayload.dyslexia_risk_score));
      sessionStorage.setItem('dyslexia_risk_level', finalPayload.dyslexia_risk_level);
      sessionStorage.setItem('confidence_level', finalPayload.confidence_level);
      sessionStorage.setItem('dominant_indicators', JSON.stringify(finalPayload.dominant_indicators));
      sessionStorage.setItem('recommendation_text', finalPayload.recommendation_text);
      sessionStorage.setItem('test_breakdown', JSON.stringify(finalPayload.test_breakdown));

      return finalPayload;
    }

    async function submitFinalPrediction() {
      const completedState = getCompletionState();
      if (!completedState.every(Boolean)) {
        document.getElementById('result').innerHTML = `<div class="alert alert-warning mt-2">Please complete all levels before prediction.</div>`;
        return;
      }

      const localEval = computeCentralEvaluation();
      document.getElementById('result').innerHTML = `<div class="alert alert-info mt-2">Generating final behavioral screening result‚Ä¶</div>`;

      const inputData = {
        Attention_Span: document.getElementById('attention').value,
        Cognitive_Score: document.getElementById('cognitive').value,
        Reading_Speed: document.getElementById('reading_speed').value,
        Spelling_Accuracy: document.getElementById('spelling_accuracy').value,
        Writing_Errors: document.getElementById('writing_errors').value,
        Phonemic_Awareness_Errors: document.getElementById('phonemic_errors').value,
        Response_Time: document.getElementById('response_time').value
      };

      try {
        const response = await fetch(`${API_BASE}/predict`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(inputData)
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        const merged = { ...data, ...localEval };
        const encoded = encodePayload(merged);
        window.location.href = `${API_BASE}/prediction-result?data=${encoded}`;
      } catch (_error) {
        // Always produce a final result unless data is unusable.
        const encoded = encodePayload(localEval);
        window.location.href = `${API_BASE}/prediction-result?data=${encoded}`;
      }
    }

    document.getElementById('submitBtn').addEventListener('click', submitFinalPrediction);
  </script>
  <script src="/assets/enter-key-helper.js"></script>
</body>
</html>
