<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Handwriting Analysis</title>
  <link rel="stylesheet" href="/assets/styles/design-tokens.css" />
  <link rel="stylesheet" href="/assets/styles/main.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <div class="container py-4">
    <a href="/home" class="btn btn-outline-primary mb-3">‚Üê Back to Home</a>
    <section class="upload-shell">
      <h1 class="h3 fw-bold text-center">Handwriting Upload & Analysis</h1>
      <p class="text-center text-muted">Upload one image and get readable, personalized feedback.</p>

      <form id="uploadForm" novalidate>
        <label for="fileInput" id="dropbox" class="upload-zone" tabindex="0">
          Drag & drop handwriting image here, or click to select.
        </label>
        <input type="file" id="fileInput" accept="image/*" hidden />
        <img id="preview" alt="Preview" class="img-fluid rounded mt-3 d-none" />
        <button id="analyzeBtn" class="btn btn-primary w-100 mt-3" type="submit" data-primary-action>Analyze Handwriting</button>
      </form>
      <div id="result" class="mt-3"></div>
    </section>
  </div>

  <script src="/assets/scripts/ui-interactions.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const result = document.getElementById('result');
    const dropbox = document.getElementById('dropbox');

    function showPreview(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
        preview.classList.remove('d-none');
      };
      reader.readAsDataURL(file);
    }

    fileInput.addEventListener('change', () => showPreview(fileInput.files[0]));
    dropbox.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
      }
    });
    dropbox.addEventListener('dragover', (e) => e.preventDefault());
    dropbox.addEventListener('drop', (e) => {
      e.preventDefault();
      if (!e.dataTransfer.files?.length) return;
      fileInput.files = e.dataTransfer.files;
      showPreview(e.dataTransfer.files[0]);
    });

    async function postHandwriting(file) {
      const formData = new FormData();
      formData.append('image', file);
      const response = await fetch('/handwriting-analysis', { method: 'POST', body: formData });
      const data = await response.json();
      if (!response.ok || data.error) throw new Error(data.error || 'Analysis failed');
      return data;
    }

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      result.className = 'mt-3 text-muted';
      if (!fileInput.files.length) {
        result.className = 'mt-3 text-danger';
        result.textContent = 'Please choose an image first.';
        return;
      }

      result.textContent = 'Analyzing handwriting...';
      try {
        const data = await postHandwriting(fileInput.files[0]);
        if (data.result_redirect) {
          window.location.href = data.result_redirect;
          return;
        }
        result.className = 'mt-3 text-success';
        result.textContent = `Prediction: ${data.predicted_class || 'Completed'}`;
      } catch (error) {
        result.className = 'mt-3 text-danger';
        result.textContent = `Service issue: ${error.message}`;
      }
    });
  </script>
</body>
</html>
