<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reading Speed Test</title>
  <link rel="stylesheet" href="/theme.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: url('/IMAGES/kids.jpg') no-repeat center center/cover; font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 660px; margin-top: 50px; background: rgba(255,255,255,.95); padding: 30px; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,.18); }
    #textToRead { height: 240px; overflow-y: auto; border: 1px solid #ccd6f3; border-radius: 10px; padding: 14px; margin-bottom: 20px; background: #f8fbff; }
    video { width: 100%; max-height: 260px; display: none; border-radius: 10px; }
  </style>
</head>
<body>
  <button class="global-back-btn" type="button" onclick="window.location.href='/home'">‚Üê Back</button>
  <div class="container">
    <h1 class="text-center mb-4">Reading Speed Test</h1>
    <p class="text-muted">A random reading passage is shown each session.</p>
    <video id="webcam" autoplay></video>
    <div class="mb-4">
      <p>Read the following text as fast as you can:</p>
      <div id="textToRead"></div>
    </div>

    <button id="startBtn" class="btn btn-primary w-100">Start Reading</button>
    <button id="stopBtn" class="btn btn-danger w-100 mt-3" style="display: none;">Stop Reading</button>
    <div id="result" class="mt-4 text-center" style="font-size: 1.2em;"></div>
    <button id="finishTestBtn" class="btn btn-info w-100 mt-3" style="display: none;">Finish Test</button>
  </div>

  <script>
    const passages = [
      "Maya loves visiting the library after school. She picks a new book every week and reads with her grandmother in the evening. Reading together helps her learn new words and understand stories better.",
      "Arjun planted tomato seeds in a small garden behind his house. Every morning he watered the plants and checked for new leaves. After a few weeks, tiny green tomatoes appeared.",
      "The school science club built a small weather station. Students measured temperature, wind, and rainfall each day. They compared the data and learned how weather changes over time.",
      "On Sunday, Aisha and her brother cleaned their room. They sorted books, folded clothes, and arranged toys on shelves. Their room looked bright, neat, and easy to study in."
    ];

    let startTime, endTime, focusTime = 0, tracking = false, videoStream, stopPressed = false;

    function shuffle(items){const arr=[...items];for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

    function loadPassage() { document.getElementById('textToRead').innerText = shuffle(passages)[0]; }

    async function startWebcam() {
      const video = document.getElementById('webcam');
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = videoStream;
        video.style.display = 'block';
        tracking = true;
        trackFocusTime();
      } catch (_error) {
        tracking = true;
        trackFocusTime();
      }
    }

    function stopWebcam() {
      if (videoStream) videoStream.getTracks().forEach(track => track.stop());
      document.getElementById('webcam').style.display = 'none';
      tracking = false;
    }

    function trackFocusTime() {
      if (!tracking) return;
      focusTime++;
      setTimeout(trackFocusTime, 1000);
    }

    document.getElementById('startBtn').addEventListener('click', function() {
      focusTime = 0;
      startTime = Date.now();
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('stopBtn').style.display = 'block';
      document.getElementById('stopBtn').disabled = false;
      stopPressed = false;
      startWebcam();
    });

    document.getElementById('stopBtn').addEventListener('click', function() {
      if (stopPressed) return;
      stopPressed = true;
      document.getElementById('stopBtn').disabled = true;

      endTime = Date.now();
      const timeTaken = Math.max((endTime - startTime) / 1000, 1);
      const wordCount = document.getElementById('textToRead').innerText.split(/\s+/).length;
      const wordsPerMinute = (wordCount / timeTaken) * 60;
      stopWebcam();

      document.getElementById('result').innerText = `Your reading speed: ${wordsPerMinute.toFixed(2)} WPM | Focus Time: ${focusTime} seconds`;
      sessionStorage.setItem('reading_speed_score', wordsPerMinute.toFixed(2));
      sessionStorage.setItem('focus_time', focusTime);
      document.getElementById('finishTestBtn').style.display = 'block';
    });

    document.getElementById('finishTestBtn').addEventListener('click', function() {
      window.location.href = "/dyslexia-prediction";
    });

    document.addEventListener('DOMContentLoaded', loadPassage);
  </script>
</body>
</html>
