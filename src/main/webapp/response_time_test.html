<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Response Time Test</title>
  <link rel="stylesheet" href="/theme.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      min-height: 100vh;
      color: #fff;
      background:
        radial-gradient(circle at 10% 18%, rgba(37,99,235,.28), transparent 38%),
        radial-gradient(circle at 86% 16%, rgba(20,184,166,.22), transparent 34%),
        linear-gradient(140deg, rgba(8,24,84,.84), rgba(52,31,115,.8)),
        url('https://images.unsplash.com/photo-1484480974693-6ca0a78fb36b?auto=format&fit=crop&w=1700&q=80') center/cover fixed;
      padding: 20px;
    }
    .test-card {
      max-width: min(980px, 96vw);
      margin: clamp(20px, 4vh, 76px) auto;
      background: rgba(9, 20, 61, 0.8);
      border: 1px solid rgba(201, 216, 255, 0.35);
      border-radius: 18px;
      padding: clamp(18px, 2.4vw, 36px);
      text-align: center;
      box-shadow: 0 18px 36px rgba(1, 10, 34, 0.34);
      backdrop-filter: blur(6px);
    }
    .signal-box {
      min-height: 180px;
      display: grid;
      place-items: center;
      border-radius: 14px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(191,219,254,.3);
      margin: 14px 0;
    }
    #promptSymbol { font-size: clamp(2.8rem, 7vw, 4.2rem); }
    .key-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; margin: 14px 0 6px; }
    .key-btn { font-weight: 700; border-radius: 12px; }
    #result { font-size: 1.02rem; margin-top: 1rem; min-height: 2rem; }
  </style>
</head>
<body>
  <button class="global-back-btn" type="button" onclick="window.location.href='index.html'">← Back</button>
  <div class="test-card">
    <h1 class="mb-2">Response Time · Signal Sprint</h1>
    <p class="text-light">Match the symbol quickly. Use keyboard (<strong>W A S L</strong>) or click buttons.</p>
    <div class="alert alert-info py-2" id="roundInfo">Round 1 of 3 · Cue 1 of 4</div>

    <div class="signal-box">
      <div id="promptSymbol">⏳</div>
      <small id="promptText" class="text-light">Press Start Round to begin.</small>
    </div>

    <button id="startBtn" class="btn btn-primary">Start Round</button>

    <div class="key-grid" id="keyGrid" style="display:none;">
      <button class="btn btn-outline-light key-btn" data-key="w">⬆️ (W)</button>
      <button class="btn btn-outline-light key-btn" data-key="a">⬅️ (A)</button>
      <button class="btn btn-outline-light key-btn" data-key="s">⬇️ (S)</button>
      <button class="btn btn-outline-light key-btn" data-key="l">➡️ (L)</button>
    </div>

    <div id="result"></div>
    <button id="finishTestBtn" class="btn btn-success mt-3" style="display:none;">Finish Test</button>
  </div>

  <script>
    const TOTAL_ROUNDS = 3;
    const CUES_PER_ROUND = 4;
    const SYMBOLS = [
      { key: 'w', symbol: '⬆️', label: 'UP' },
      { key: 'a', symbol: '⬅️', label: 'LEFT' },
      { key: 's', symbol: '⬇️', label: 'DOWN' },
      { key: 'l', symbol: '➡️', label: 'RIGHT' },
    ];

    let currentRound = 1;
    let cueIndex = 0;
    let waitingForInput = false;
    let startedAt = 0;
    let activePrompt = null;
    let roundTimes = [];
    const allTimes = [];

    function updateRoundLabel() {
      document.getElementById('roundInfo').textContent = `Round ${currentRound} of ${TOTAL_ROUNDS} · Cue ${Math.min(cueIndex + 1, CUES_PER_ROUND)} of ${CUES_PER_ROUND}`;
    }

    function randomPrompt() {
      return SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
    }

    function showPrompt() {
      activePrompt = randomPrompt();
      document.getElementById('promptSymbol').textContent = activePrompt.symbol;
      document.getElementById('promptText').textContent = `Press ${activePrompt.label}`;
      startedAt = Date.now();
      waitingForInput = true;
    }

    function nextCue() {
      if (cueIndex >= CUES_PER_ROUND) {
        const avgRound = roundTimes.reduce((a, b) => a + b, 0) / roundTimes.length;
        document.getElementById('result').innerHTML = `<div class='alert alert-info'>Round ${currentRound} complete · Avg ${avgRound.toFixed(3)}s</div>`;
        currentRound += 1;
        cueIndex = 0;
        roundTimes = [];
        if (currentRound > TOTAL_ROUNDS) {
          finishGame();
          return;
        }
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('startBtn').textContent = 'Start Next Round';
        document.getElementById('keyGrid').style.display = 'none';
        document.getElementById('promptSymbol').textContent = '⏳';
        document.getElementById('promptText').textContent = 'Prepare for next round.';
        updateRoundLabel();
        return;
      }

      updateRoundLabel();
      setTimeout(showPrompt, 700 + Math.random() * 900);
    }

    function handleResponse(key) {
      if (!waitingForInput || !activePrompt) return;
      if (key !== activePrompt.key) {
        document.getElementById('result').innerHTML = `<span class='text-warning'>Wrong key. Match the shown direction!</span>`;
        return;
      }

      waitingForInput = false;
      const t = Math.max((Date.now() - startedAt) / 1000, 0.05);
      roundTimes.push(t);
      allTimes.push(t);
      cueIndex += 1;
      document.getElementById('result').innerHTML = `<span class='text-success'>Good! ${t.toFixed(3)} sec</span>`;
      nextCue();
    }

    function finishGame() {
      const avg = allTimes.reduce((a, b) => a + b, 0) / allTimes.length;
      sessionStorage.setItem('response_time_score', avg.toFixed(3));
      document.getElementById('roundInfo').textContent = 'Completed';
      document.getElementById('result').innerHTML = `<div class='alert alert-success'>Average response time: <strong>${avg.toFixed(3)} sec</strong><br><small>Lower is better.</small></div>`;
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('keyGrid').style.display = 'none';
      document.getElementById('finishTestBtn').style.display = 'inline-block';
      document.getElementById('promptSymbol').textContent = '✅';
      document.getElementById('promptText').textContent = 'Signal Sprint complete.';
    }

    document.getElementById('startBtn').addEventListener('click', function() {
      this.style.display = 'none';
      document.getElementById('keyGrid').style.display = 'grid';
      document.getElementById('result').innerText = 'Watch for the cue...';
      nextCue();
    });

    document.querySelectorAll('.key-btn').forEach((btn) => {
      btn.addEventListener('click', () => handleResponse(btn.dataset.key));
    });

    document.addEventListener('keydown', (event) => {
      const key = event.key.toLowerCase();
      if (event.key === 'Enter') {
        const startBtn = document.getElementById('startBtn');
        if (startBtn.style.display !== 'none' && !startBtn.disabled) {
          event.preventDefault();
          startBtn.click();
          return;
        }
      }
      if (['w', 'a', 's', 'l'].includes(key)) {
        handleResponse(key);
      }
    });

    document.getElementById('finishTestBtn').addEventListener('click', function() {
      window.location.href = '/dyslexia-prediction';
    });

    updateRoundLabel();
  </script>
</body>
</html>
