<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rapid Naming Test</title>
  <link rel="stylesheet" href="/theme.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      font-family: 'Inter', Arial, sans-serif;
      color: #0f172a;
      padding: 20px;
      background:
        radial-gradient(circle at 14% 14%, rgba(37,99,235,.15), transparent 42%),
        radial-gradient(circle at 84% 10%, rgba(16,185,129,.15), transparent 35%),
        linear-gradient(155deg, rgba(12,31,88,.68), rgba(69,94,199,.56)),
        url('/IMAGES/kids.jpg') center/cover no-repeat;
    }
    .container {
      max-width: min(1080px, 96vw);
      background: rgba(255,255,255,.96);
      padding: clamp(20px, 2.4vw, 38px);
      border-radius: 18px;
      box-shadow: 0 18px 36px rgba(0,0,0,.2);
    }
    .viewer {
      min-height: 230px;
      border-radius: 14px;
      border: 1px dashed #a8c2ff;
      background: linear-gradient(180deg, #f8fbff, #f2f8ff);
      display: grid;
      place-items: center;
      margin: 14px 0;
      text-align: center;
      padding: 12px;
    }
    .viewer img {
      max-height: 190px;
      border-radius: 10px;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
    }
  </style>
</head>
<body>
  <button class="global-back-btn" type="button" onclick="window.location.href='index.html'">← Back</button>
  <div class="container">
    <h1 class="text-center mb-2">Rapid Naming · Image Sequence</h1>
    <p class="text-muted text-center">Animals appear one after another. Type which animal came <strong>first</strong> and the full order.</p>

    <div class="d-flex justify-content-between align-items-center">
      <div id="roundInfo" class="fw-semibold text-primary">Level 1 / 2</div>
      <small class="text-muted">Memory + naming speed combined</small>
    </div>

    <div id="viewer" class="viewer">Press <strong>Start Level</strong> to begin sequence playback.</div>

    <button id="startBtn" class="btn btn-primary w-100">Start Level</button>
    <textarea id="answer" class="form-control mt-3" rows="3" placeholder="Format: first=cat | order=cat,dog,lion,rabbit"></textarea>
    <button id="submitBtn" class="btn btn-success w-100 mt-2" disabled>Submit Level</button>

    <div id="result" class="mt-3"></div>
    <button id="finishTestBtn" class="btn btn-info w-100 mt-3" style="display:none;">Finish Test</button>
  </div>

  <script>
    const LEVELS = [
      { name: 'Sequence A' },
      { name: 'Sequence B' }
    ];

    const animals = [
      { label: 'cat', url: 'https://upload.wikimedia.org/wikipedia/commons/4/4d/Cat_November_2010-1a.jpg' },
      { label: 'dog', url: 'https://images.unsplash.com/photo-1517849845537-4d257902454a?auto=format&fit=crop&w=900&q=80' },
      { label: 'lion', url: 'https://images.unsplash.com/photo-1546182990-dffeafbe841d?auto=format&fit=crop&w=900&q=80' },
      { label: 'rabbit', url: 'https://images.unsplash.com/photo-1585110396000-c9ffd4e4b308?auto=format&fit=crop&w=900&q=80' },
      { label: 'horse', url: 'https://images.unsplash.com/photo-1553284965-83fd3e82fa5a?auto=format&fit=crop&w=900&q=80' },
      { label: 'elephant', url: 'https://upload.wikimedia.org/wikipedia/commons/3/37/African_Bush_Elephant.jpg' },
    ];

    let currentLevel = 0;
    let sequence = [];
    let startedAt = null;
    const levelScores = [];

    function pickRandom(items, n) {
      const copy = [...items];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }

    function updateRoundInfo() {
      document.getElementById('roundInfo').textContent = `Level ${currentLevel + 1} / ${LEVELS.length} — ${LEVELS[currentLevel].name}`;
    }

    function playSequence() {
      sequence = pickRandom(animals, 4);
      const viewer = document.getElementById('viewer');
      let idx = 0;

      function showNext() {
        if (idx >= sequence.length) {
          viewer.innerHTML = '<strong>Sequence done.</strong><br>Type first animal and full order.';
          document.getElementById('submitBtn').disabled = false;
          return;
        }

        const animal = sequence[idx];
        viewer.innerHTML = `<img src="${animal.url}" alt="Frame ${idx + 1}"><div class='mt-2 text-muted'>Frame ${idx + 1} / ${sequence.length}</div>`;
        idx += 1;
        setTimeout(showNext, 1200);
      }

      showNext();
    }

    function parseAnswer(value) {
      const input = value.toLowerCase();
      const first = (input.split('first=')[1] || '').split('|')[0].trim();
      const orderPart = (input.split('order=')[1] || '').trim();
      const order = orderPart.split(',').map((x) => x.trim()).filter(Boolean);
      return { first, order };
    }

    function scoreLevel(answerText, elapsed) {
      const parsed = parseAnswer(answerText);
      const targetOrder = sequence.map((a) => a.label);

      let accuracy = 0;
      if (parsed.first === targetOrder[0]) accuracy += 35;

      let orderCorrect = 0;
      for (let i = 0; i < Math.min(parsed.order.length, targetOrder.length); i++) {
        if (parsed.order[i] === targetOrder[i]) orderCorrect += 1;
      }
      accuracy += (orderCorrect / targetOrder.length) * 65;

      const speedPenalty = Math.min((elapsed / 16) * 18, 18);
      const namingScore = Math.max(0, Math.min(100, accuracy - speedPenalty));
      return { accuracy, namingScore };
    }

    function renderFinalSummary() {
      const avgScore = levelScores.reduce((a, b) => a + b.namingScore, 0) / levelScores.length;
      const avgAccuracy = levelScores.reduce((a, b) => a + b.accuracy, 0) / levelScores.length;
      const avgTime = levelScores.reduce((a, b) => a + b.elapsed, 0) / levelScores.length;

      sessionStorage.setItem('attention_score', avgScore.toFixed(2));
      sessionStorage.setItem('rapid_naming_accuracy', avgAccuracy.toFixed(2));
      sessionStorage.setItem('rapid_naming_seconds', avgTime.toFixed(2));

      document.getElementById('result').innerHTML = `
        <div class="alert alert-success">
          <strong>Rapid Naming Score:</strong> ${avgScore.toFixed(2)}/100<br>
          <strong>Average Accuracy:</strong> ${avgAccuracy.toFixed(2)}%<br>
          <strong>Average Time / Level:</strong> ${avgTime.toFixed(2)} sec
        </div>`;
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('finishTestBtn').style.display = 'block';
      document.getElementById('viewer').innerHTML = '✅ Completed';
    }

    document.getElementById('startBtn').addEventListener('click', () => {
      updateRoundInfo();
      document.getElementById('startBtn').disabled = true;
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('result').innerHTML = `<span class="text-primary">Level ${currentLevel + 1} started. Watch carefully.</span>`;
      startedAt = Date.now();
      playSequence();
    });

    document.getElementById('submitBtn').addEventListener('click', () => {
      if (!startedAt) return;
      const answerText = document.getElementById('answer').value.trim();
      if (!answerText) {
        document.getElementById('result').innerHTML = `<span class='text-danger'>Please type your answer first.</span>`;
        return;
      }

      const elapsed = Math.max((Date.now() - startedAt) / 1000, 1);
      const scored = scoreLevel(answerText, elapsed);
      levelScores.push({ accuracy: scored.accuracy, elapsed, namingScore: scored.namingScore });

      currentLevel += 1;
      if (currentLevel >= LEVELS.length) {
        renderFinalSummary();
        return;
      }

      startedAt = null;
      document.getElementById('answer').value = '';
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('startBtn').disabled = false;
      document.getElementById('startBtn').textContent = 'Start Next Level';
      document.getElementById('viewer').innerHTML = 'Ready for next sequence';
      document.getElementById('result').innerHTML = `
        <div class="alert alert-info">
          Level ${currentLevel} complete · Accuracy ${scored.accuracy.toFixed(2)}% · Time ${elapsed.toFixed(2)}s
        </div>`;
      updateRoundInfo();
    });

    document.getElementById('finishTestBtn').addEventListener('click', () => {
      window.location.href = '/dyslexia-prediction';
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Enter') return;
      const active = document.activeElement;
      const inTextArea = active && active.tagName === 'TEXTAREA';
      if (inTextArea && event.shiftKey) return;
      event.preventDefault();

      const startBtn = document.getElementById('startBtn');
      const submitBtn = document.getElementById('submitBtn');
      if (!startBtn.disabled) startBtn.click();
      else if (!submitBtn.disabled) submitBtn.click();
    });

    updateRoundInfo();
  </script>
</body>
</html>
