<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rapid Naming Test</title>
  <link rel="stylesheet" href="/theme.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: url('/IMAGES/kids.jpg') no-repeat center center/cover; min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:16px; }
    .container { max-width: 980px; background: rgba(255,255,255,.95); padding: 28px; border-radius: 14px; box-shadow: 0 10px 24px rgba(0,0,0,.18); }
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin:16px 0; }
    .tile { border:1px solid #d6e2ff; background:#f7faff; padding:12px; text-align:center; border-radius:8px; font-weight:700; font-size:1.1rem; }
  </style>
</head>
<body>
  <button class="global-back-btn" type="button" onclick="window.location.href='index.html'">‚Üê Back</button>
  <div class="container">
    <h1 class="text-center mb-3">Rapid Naming Test (High Priority)</h1>
    <p class="text-muted">Complete <strong>3 short rounds</strong>. This improves reliability by combining confusable letters and regular words while reducing fatigue.</p>
    <div class="d-flex justify-content-between align-items-center">
      <div id="roundInfo" class="fw-semibold text-primary">Round 1 / 3</div>
      <small class="text-muted">3-column grid for easier left-to-right reading</small>
    </div>
    <div id="symbolGrid" class="grid"></div>

    <button id="startBtn" class="btn btn-primary w-100">Start Round</button>
    <textarea id="answer" class="form-control mt-3" rows="3" placeholder="Type items separated by spaces (e.g., b d map q sun)"></textarea>
    <button id="submitBtn" class="btn btn-success w-100 mt-2" disabled>Submit Round</button>

    <div id="result" class="mt-3"></div>
    <button id="finishTestBtn" class="btn btn-info w-100 mt-3" style="display:none;">Finish Test</button>
  </div>

  <script>
    const ROUND_COUNT = 3;
    const ITEMS_PER_ROUND = 9;
    const ROUND_POOLS = [
      ["b", "d", "p", "q", "m", "n", "sun", "map", "dog"],
      ["was", "saw", "form", "from", "trail", "trial", "red", "book", "tree"],
      ["u", "v", "w", "t", "tap", "pat", "left", "felt", "lamp"],
    ];

    let currentRound = 0;
    let sequence = [];
    let startedAt = null;
    const roundScores = [];

    function normalize(text) {
      return text.toLowerCase().replace(/[^a-z\s]/g, ' ').trim().split(/\s+/).filter(Boolean);
    }

    function shuffle(items) {
      const copy = [...items];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function buildSequence(roundIndex) {
      const pool = ROUND_POOLS[roundIndex % ROUND_POOLS.length];
      sequence = shuffle(pool).slice(0, ITEMS_PER_ROUND);
      const host = document.getElementById('symbolGrid');
      host.innerHTML = sequence.map((x) => `<div class="tile">${x}</div>`).join('');
      document.getElementById('roundInfo').textContent = `Round ${roundIndex + 1} / ${ROUND_COUNT}`;
    }

    function renderFinalSummary() {
      const avgScore = roundScores.reduce((a, b) => a + b.namingScore, 0) / roundScores.length;
      const avgAccuracy = roundScores.reduce((a, b) => a + b.accuracy, 0) / roundScores.length;
      const avgTime = roundScores.reduce((a, b) => a + b.elapsed, 0) / roundScores.length;

      sessionStorage.setItem('attention_score', avgScore.toFixed(2));
      sessionStorage.setItem('rapid_naming_accuracy', avgAccuracy.toFixed(2));
      sessionStorage.setItem('rapid_naming_seconds', avgTime.toFixed(2));

      document.getElementById('result').innerHTML = `
        <div class="alert alert-success">
          <strong>Rapid Naming Score:</strong> ${avgScore.toFixed(2)}/100<br>
          <strong>Average Accuracy:</strong> ${avgAccuracy.toFixed(2)}%<br>
          <strong>Average Time / Round:</strong> ${avgTime.toFixed(2)} sec<br>
          <strong>Rounds Completed:</strong> ${ROUND_COUNT}
        </div>`;
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('finishTestBtn').style.display = 'block';
    }

    document.getElementById('startBtn').addEventListener('click', () => {
      buildSequence(currentRound);
      startedAt = Date.now();
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('result').innerHTML = `<span class="text-primary">Round ${currentRound + 1} started. Type the sequence then submit.</span>`;
    });

    document.getElementById('submitBtn').addEventListener('click', () => {
      if (!startedAt) return;

      const elapsed = Math.max((Date.now() - startedAt) / 1000, 1);
      const typed = normalize(document.getElementById('answer').value);
      const target = sequence;
      const min = Math.min(typed.length, target.length);
      let correct = 0;
      for (let i = 0; i < min; i++) if (typed[i] === target[i]) correct++;

      const accuracy = (correct / target.length) * 100;
      const speedPenalty = Math.min((elapsed / 20) * 18, 18);
      const namingScore = Math.max(0, Math.min(100, accuracy - speedPenalty));

      roundScores.push({ accuracy, elapsed, namingScore });
      currentRound += 1;

      if (currentRound >= ROUND_COUNT) {
        renderFinalSummary();
        return;
      }

      document.getElementById('answer').value = '';
      startedAt = null;
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('startBtn').disabled = false;
      document.getElementById('result').innerHTML = `
        <div class="alert alert-info">
          <strong>Round ${currentRound} complete.</strong>
          Accuracy: ${accuracy.toFixed(2)}% | Time: ${elapsed.toFixed(2)} sec.
          Click <strong>Start Round</strong> for round ${currentRound + 1}.
        </div>`;
      buildSequence(currentRound);
    });

    document.getElementById('finishTestBtn').addEventListener('click', () => {
      window.location.href = '/dyslexia-prediction';
    });

    buildSequence(0);
  </script>
</body>
</html>
