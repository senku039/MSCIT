<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rapid Naming Test</title>
  <link rel="stylesheet" href="/theme.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: url('/IMAGES/kids.jpg') no-repeat center center/cover; font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: min(1200px, 96vw); background: rgba(255,255,255,.96); padding: clamp(20px, 2.4vw, 38px); border-radius: 16px; box-shadow: 0 14px 30px rgba(0,0,0,.18); }
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin:16px 0; }
    .tile { border:1px solid #d6e2ff; background:#f7faff; padding:12px; text-align:center; border-radius:8px; font-weight:700; font-size:1.1rem; }
  </style>
</head>
<body>
  <button class="global-back-btn" type="button" onclick="window.location.href='index.html'">← Back</button>
  <div class="container">
    <h1 class="text-center mb-3">Rapid Naming Test (High Priority)</h1>
    <p class="text-muted">Complete only <strong>2 levels</strong>: one for <strong>letters</strong> and one for <strong>words</strong>.</p>
    <div class="d-flex justify-content-between align-items-center">
      <div id="roundInfo" class="fw-semibold text-primary">Level 1 / 2 — Letters</div>
      <small class="text-muted">Read left-to-right and type in order</small>
    </div>

    <div id="viewer" class="viewer">Press <strong>Start Level</strong> to begin sequence playback.</div>

    <button id="startBtn" class="btn btn-primary w-100">Start Level</button>
    <textarea id="answer" class="form-control mt-3" rows="3" placeholder="Format: first=cat | order=cat,dog,lion,rabbit"></textarea>
    <button id="submitBtn" class="btn btn-success w-100 mt-2" disabled>Submit Level</button>

    <div id="result" class="mt-3"></div>
    <button id="finishTestBtn" class="btn btn-info w-100 mt-3" style="display:none;">Finish Test</button>
  </div>

  <script>
    const GRID_ROWS = 5;
    const GRID_COLS = 10;
    const TOTAL_ITEMS = GRID_ROWS * GRID_COLS;

    const LETTER_POOL = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    const WORD_POOL = [
      'cat', 'dog', 'sun', 'book', 'table', 'apple', 'water', 'paper', 'happy', 'pencil',
      'school', 'window', 'music', 'flower', 'rabbit', 'button', 'yellow', 'mother', 'garden', 'planet'
    ];

    let testStartedAt = null;
    let timerHandle = null;
    let currentSetType = 'letters';

    function pickRandomItems(pool, count) {
      const out = [];
      for (let i = 0; i < count; i += 1) {
        out.push(pool[Math.floor(Math.random() * pool.length)]);
      }
      return out;
    }

    function shuffle(items) {
      const arr = [...items];
      for (let i = arr.length - 1; i > 0; i -= 1) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function renderGrid() {
      currentSetType = Math.random() < 0.5 ? 'letters' : 'words';
      const source = currentSetType === 'letters' ? LETTER_POOL : WORD_POOL;
      const items = shuffle(pickRandomItems(source, TOTAL_ITEMS));

      const viewer = document.getElementById('viewer');
      viewer.innerHTML = `<div class="grid" style="grid-template-columns: repeat(10, 1fr);">${items.map((item) => `<div class="tile">${item.toUpperCase()}</div>`).join('')}</div>`;

      document.getElementById('roundInfo').textContent = `Rapid Naming Set: ${currentSetType === 'letters' ? 'Letters' : 'Words'} (${TOTAL_ITEMS} items)`;
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      const tenths = Math.floor((seconds - Math.floor(seconds)) * 10);
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${tenths}`;
    }

    function updateTimer() {
      if (!testStartedAt) return;
      const elapsed = (Date.now() - testStartedAt) / 1000;
      document.getElementById('roundInfo').textContent = `Rapid Naming Set: ${currentSetType === 'letters' ? 'Letters' : 'Words'} (${TOTAL_ITEMS} items) • Time: ${formatTime(elapsed)}`;
    }

    function startTest() {
      renderGrid();
      testStartedAt = Date.now();
      document.getElementById('result').innerHTML = '<span class="text-primary">Timer started. Read all items aloud, then click <strong>Finish Test</strong>.</span>';
      document.getElementById('startBtn').disabled = true;
      document.getElementById('startBtn').textContent = 'Test Running';
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('finishTestBtn').style.display = 'none';

      if (timerHandle) clearInterval(timerHandle);
      updateTimer();
      timerHandle = setInterval(updateTimer, 100);
    }

    function finishTest() {
      if (!testStartedAt) return;
      const elapsedSeconds = Math.max((Date.now() - testStartedAt) / 1000, 1);
      const itemsPerMinute = (TOTAL_ITEMS / elapsedSeconds) * 60;

      if (timerHandle) {
        clearInterval(timerHandle);
        timerHandle = null;
      }

      localStorage.setItem('rapid_naming_score', itemsPerMinute.toFixed(2));
      sessionStorage.setItem('attention_score', itemsPerMinute.toFixed(2));
      sessionStorage.setItem('rapid_naming_seconds', elapsedSeconds.toFixed(2));

      document.getElementById('result').innerHTML = `
        <div class="alert alert-success">
          <strong>Total Time:</strong> ${elapsedSeconds.toFixed(2)} sec<br>
          <strong>Items per Minute:</strong> ${itemsPerMinute.toFixed(2)}
        </div>`;

      document.getElementById('roundInfo').textContent = `Completed • Total Time: ${formatTime(elapsedSeconds)}`;
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('finishTestBtn').style.display = 'block';
    }

    document.getElementById('startBtn').textContent = 'Start Test';
    document.getElementById('submitBtn').textContent = 'Finish Test';
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('answer').style.display = 'none';

    document.getElementById('startBtn').addEventListener('click', startTest);
    document.getElementById('submitBtn').addEventListener('click', finishTest);

    document.getElementById('finishTestBtn').addEventListener('click', () => {
      window.location.href = '/dyslexia-prediction';
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Enter') return;
      event.preventDefault();

      const startBtn = document.getElementById('startBtn');
      const finishBtn = document.getElementById('submitBtn');
      const doneBtn = document.getElementById('finishTestBtn');

      if (doneBtn.style.display !== 'none') {
        doneBtn.click();
        return;
      }
      if (!startBtn.disabled) {
        startBtn.click();
        return;
      }
      if (!finishBtn.disabled) {
        finishBtn.click();
      }
    });
  </script>
</body>
</html>
