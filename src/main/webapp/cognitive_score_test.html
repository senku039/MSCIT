<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cognitive Score Test</title>
  <link rel="stylesheet" href="/theme.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      min-height: 100vh;
      color: #0f172a;
      padding: 20px;
      background:
        radial-gradient(circle at 12% 14%, rgba(37,99,235,.17), transparent 40%),
        radial-gradient(circle at 88% 18%, rgba(99,102,241,.17), transparent 36%),
        linear-gradient(140deg, rgba(7,27,84,.7), rgba(95,57,180,.6)),
        url('/IMAGES/kids.jpg') center/cover no-repeat;
    }
    .page-shell {
      max-width: min(1240px, 96vw);
      margin: clamp(18px, 4vh, 46px) auto;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #d6e2ff;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(11, 24, 74, 0.26);
      padding: clamp(20px, 2.6vw, 40px);
    }
    .game-title { font-weight: 800; color: #172a65; }
    .helper-text { color: #4e5e8f; font-size: 0.95rem; }
    .stage-card {
      border: 1px solid #d8e3ff;
      background: linear-gradient(180deg, #ffffff, #f8fbff);
      border-radius: 14px;
      padding: 16px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
    }
    .sequence-board {
      min-height: 190px;
      display: grid;
      place-items: center;
      border: 1px dashed #9fb8ff;
      border-radius: 12px;
      background: #f5f9ff;
      margin: 8px 0 10px;
      padding: 10px;
      text-align: center;
    }
    .sequence-board img { max-height: 170px; width: auto; border-radius: 10px; box-shadow: 0 8px 16px rgba(0,0,0,.18); }
    .badge-soft {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .75rem;
      font-weight: 700;
      background: #e8efff;
      color: #304da7;
      border: 1px solid #cddcff;
    }
  </style>
</head>
<body>
  <button class="global-back-btn" type="button" onclick="window.location.href='index.html'">← Back</button>
  <div class="page-shell">
    <h1 class="text-center mb-2 game-title">Cognitive Challenge Arena</h1>
    <p class="text-center helper-text mb-4">A 4-stage smart challenge: memory recall, image-order reasoning, logic sprint, and language completion.</p>

    <div id="taskContainer">
      <div id="memoryTest" class="mb-4 stage-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="m-0">Stage 1 · Memory Flash</h3>
          <span class="badge-soft" id="memoryTimer">Memorize: 8s</span>
        </div>
        <p class="helper-text mb-2">Memorize the words below. They will disappear.</p>
        <p class="fw-semibold" id="memoryWords"></p>
        <input type="text" id="memoryInput" class="form-control" placeholder="Type the words you remember (comma separated)" required>
      </div>

      <div id="attentionTest" class="mb-4 stage-card" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="m-0">Stage 2 · Animal Sequence</h3>
          <span class="badge-soft" id="sequenceHint">Watch carefully</span>
        </div>
        <p class="helper-text">Images appear one by one. After playback, type <strong>the first animal shown</strong> and the full order.</p>
        <div id="sequenceBoard" class="sequence-board">Press <strong>Submit &amp; Next</strong> to start playback.</div>
        <input type="text" id="attentionInput" class="form-control mt-2" placeholder="Format: first=cat | order=cat,dog,lion" required>
      </div>

      <div id="problemSolvingTest" class="mb-4 stage-card" style="display: none;">
        <h3>Stage 3 · Logic Sprint</h3>
        <p id="problemQuestion" class="helper-text">Loading puzzle...</p>
        <input type="text" id="problemInput" class="form-control" placeholder="Your answer" required>
      </div>

      <div id="languageTest" class="mb-4 stage-card" style="display: none;">
        <h3>Stage 4 · Language Precision</h3>
        <p id="languageQuestion" class="helper-text">Loading question...</p>
        <input type="text" id="languageInput" class="form-control" placeholder="Your answer" required>
      </div>
    </div>

    <button id="submitBtn" class="btn btn-primary w-100">Submit &amp; Next</button>
    <div id="result" class="mt-3 text-center fw-semibold"></div>
    <button id="finishTestBtn" class="btn btn-success w-100 mt-3" style="display: none;">Finish Test</button>
  </div>

  <script>
    const memoryWordSets = [
      ["apple", "rocket", "garden", "mirror"],
      ["planet", "bridge", "camera", "window"],
      ["forest", "pencil", "tiger", "silver"],
      ["castle", "orange", "ocean", "lantern"]
    ];

    const imageLinks = [
      { label: "cat", url: "https://upload.wikimedia.org/wikipedia/commons/4/4d/Cat_November_2010-1a.jpg" },
      { label: "elephant", url: "https://upload.wikimedia.org/wikipedia/commons/3/37/African_Bush_Elephant.jpg" },
      { label: "dog", url: "https://images.unsplash.com/photo-1517849845537-4d257902454a?auto=format&fit=crop&w=900&q=80" },
      { label: "horse", url: "https://images.unsplash.com/photo-1553284965-83fd3e82fa5a?auto=format&fit=crop&w=900&q=80" },
      { label: "lion", url: "https://images.unsplash.com/photo-1546182990-dffeafbe841d?auto=format&fit=crop&w=900&q=80" },
      { label: "rabbit", url: "https://images.unsplash.com/photo-1585110396000-c9ffd4e4b308?auto=format&fit=crop&w=900&q=80" }
    ];

    const problemQuestions = [
      { question: "Find next number: 3, 6, 12, 24, ?", answer: "48" },
      { question: "If all Bloops are Razzles and all Razzles are Lazzles, are all Bloops Lazzles? (yes/no)", answer: "yes" },
      { question: "A bag has 5 red and 3 blue balls. Probability of picking red (fraction)?", answer: "5/8" },
      { question: "Rearrange letters to form a word: N E I R B A (hint: body part)", answer: "brain" }
    ];

    const languageQuestions = [
      { question: 'Complete: "The scientist carefully ___ the result."', answer: "recorded" },
      { question: 'Fill in: "She ___ a beautiful melody yesterday."', answer: "sang" },
      { question: 'Complete: "Ideas ___ when we practice daily."', answer: "grow" }
    ];

    function pickRandom(list, count = 1) {
      const cloned = [...list];
      for (let i = cloned.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [cloned[i], cloned[j]] = [cloned[j], cloned[i]];
      }
      return cloned.slice(0, count);
    }

    const tests = [
      { id: 'memoryTest', inputId: 'memoryInput', correctAnswer: '', score: 0 },
      { id: 'attentionTest', inputId: 'attentionInput', correctAnswer: '', score: 0 },
      { id: 'problemSolvingTest', inputId: 'problemInput', correctAnswer: '', score: 0 },
      { id: 'languageTest', inputId: 'languageInput', correctAnswer: '', score: 0 }
    ];

    let currentTestIndex = 0;
    let totalScore = 0;
    let animalSequence = [];
    let sequencePlayed = false;

    function loadMemoryChallenge() {
      const words = pickRandom(memoryWordSets, 1)[0];
      document.getElementById('memoryWords').textContent = words.join(', ');
      tests[0].correctAnswer = words.map((w) => w.toLowerCase()).sort().join(',');

      let timer = 8;
      const timerEl = document.getElementById('memoryTimer');
      timerEl.textContent = `Memorize: ${timer}s`;
      const interval = setInterval(() => {
        timer -= 1;
        timerEl.textContent = `Memorize: ${Math.max(timer, 0)}s`;
        if (timer <= 0) {
          clearInterval(interval);
          document.getElementById('memoryWords').textContent = '••• hidden •••';
          timerEl.textContent = 'Recall now';
        }
      }, 1000);
    }

    function playAnimalSequence() {
      const board = document.getElementById('sequenceBoard');
      const hint = document.getElementById('sequenceHint');
      animalSequence = pickRandom(imageLinks, 4);
      tests[1].correctAnswer = animalSequence.map((a) => a.label).join(',');
      sequencePlayed = true;

      let idx = 0;
      hint.textContent = 'Playing...';

      function showNext() {
        if (idx >= animalSequence.length) {
          board.innerHTML = '<strong>Sequence complete.</strong><br>Type: first=&lt;animal&gt; | order=&lt;a,b,c,d&gt;';
          hint.textContent = 'Now answer';
          return;
        }
        const item = animalSequence[idx];
        board.innerHTML = `<img src="${item.url}" alt="Animal frame ${idx + 1}" loading="lazy"><div class="mt-2 text-muted">Frame ${idx + 1} / ${animalSequence.length}</div>`;
        idx += 1;
        setTimeout(showNext, 1250);
      }

      showNext();
    }

    function loadRandomQuestion(type) {
      const source = type === 'problem' ? problemQuestions : languageQuestions;
      const picked = pickRandom(source, 1)[0];
      if (type === 'problem') {
        document.getElementById('problemQuestion').textContent = picked.question;
        tests[2].correctAnswer = picked.answer.toLowerCase();
      } else {
        document.getElementById('languageQuestion').textContent = picked.question;
        tests[3].correctAnswer = picked.answer.toLowerCase();
      }
    }

    function normalizeCommaWords(text) {
      return text.toLowerCase().split(',').map((x) => x.trim()).filter(Boolean).sort().join(',');
    }

    function evaluateAttentionInput(input) {
      const value = input.toLowerCase();
      const first = animalSequence[0]?.label || '';
      const order = tests[1].correctAnswer;
      let score = 0;

      if (value.includes(`first=${first}`)) score += 60;
      const orderPart = value.split('order=')[1] || '';
      const normalizedOrder = orderPart.split(',').map((x) => x.trim()).filter(Boolean).join(',');
      if (normalizedOrder === order) score += 40;
      return score;
    }

    function submitCurrentTest() {
      const test = tests[currentTestIndex];
      const currentInput = document.getElementById(test.inputId);
      const userAnswer = currentInput.value.trim();

      if (!userAnswer) {
        document.getElementById('result').innerText = 'Please enter an answer before proceeding.';
        return;
      }

      let testScore = 0;
      if (test.id === 'memoryTest') {
        testScore = normalizeCommaWords(userAnswer) === test.correctAnswer ? 100 : 55;
      } else if (test.id === 'attentionTest') {
        testScore = evaluateAttentionInput(userAnswer);
      } else {
        testScore = userAnswer.toLowerCase() === test.correctAnswer ? 100 : 60;
      }

      test.score = testScore;
      totalScore += testScore;

      document.getElementById(test.id).style.display = 'none';
      currentTestIndex++;

      if (currentTestIndex < tests.length) {
        const nextTest = tests[currentTestIndex];
        document.getElementById(nextTest.id).style.display = 'block';
        document.getElementById(nextTest.inputId).focus();

        if (nextTest.id === 'attentionTest' && !sequencePlayed) {
          playAnimalSequence();
        }

        document.getElementById('result').innerText = `Stage score: ${testScore}. Keep going!`;
      } else {
        const finalScore = totalScore / tests.length;
        sessionStorage.setItem('cognitive_score_score', finalScore.toFixed(2));
        document.getElementById('result').innerHTML = `
          <div class="alert alert-success">
            <strong>Cognitive Score:</strong> ${finalScore.toFixed(2)} / 100
          </div>`;
        document.getElementById('submitBtn').style.display = 'none';
        document.getElementById('finishTestBtn').style.display = 'block';
      }
    }

    document.getElementById('submitBtn').addEventListener('click', submitCurrentTest);

    document.getElementById('finishTestBtn').addEventListener('click', function() {
      window.location.href = '/dyslexia-prediction';
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Enter') return;
      const btn = document.getElementById('submitBtn');
      if (btn && btn.style.display !== 'none') {
        event.preventDefault();
        btn.click();
      }
    });

    loadMemoryChallenge();
    loadRandomQuestion('problem');
    loadRandomQuestion('language');
  </script>
</body>
</html>
