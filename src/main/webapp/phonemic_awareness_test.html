<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phonemic Awareness Test</title>
  <link rel="stylesheet" href="/theme.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: url('/IMAGES/kids.jpg') no-repeat center center/cover; }
    .container { max-width: min(1180px, 96vw); margin-top: clamp(18px, 4vh, 48px); background: rgba(255,255,255,.96); padding: clamp(18px, 2.5vw, 36px); border-radius: 14px; box-shadow: 0 12px 28px rgba(0,0,0,.18); }
    .feedback { margin-top: 20px; font-size: 1.1em; }
    .correct { color: green; }
    .incorrect { color: red; }
    .options button { margin: 8px; min-width: 120px; }
  </style>
</head>
<body>
  <button class="global-back-btn" type="button" onclick="window.location.href='index.html'">← Back</button>
  <div class="container text-center">
    <h1 class="mb-3">Phonemic Awareness Test</h1>
    <p class="text-muted">Questions are randomized each time with both normal words and commonly confusable patterns.</p>
    <p>Listen to the word and select the matching word.</p>

    <button id="speakButton" class="btn btn-primary mb-3">Hear the Word</button>
    <div id="options" class="options mb-2"></div>
    <div id="feedback" class="feedback"></div>
    <div class="text-center mt-3"><button id="nextButton" class="btn btn-success" disabled>Next</button></div>
    <button id="finishTestBtn" class="btn btn-info w-100 mt-3" style="display: none;">Finish Test</button>
  </div>

  <script>
    const questionBank = [
      { prompt: 'dog', options: ['dog', 'dig', 'dug', 'fog'], correct: 'dog' },
      { prompt: 'ship', options: ['shop', 'ship', 'sheep', 'chip'], correct: 'ship' },
      { prompt: 'bat', options: ['bit', 'bat', 'bet', 'bad'], correct: 'bat' },
      { prompt: 'pen', options: ['pan', 'pin', 'pen', 'pet'], correct: 'pen' },
      { prompt: 'cat', options: ['cot', 'cut', 'cat', 'cap'], correct: 'cat' },
      { prompt: 'sun', options: ['sin', 'son', 'sun', 'sung'], correct: 'sun' },
      { prompt: 'bed', options: ['bed', 'bad', 'beg', 'bet'], correct: 'bed' },
      { prompt: 'dime', options: ['dime', 'time', 'dine', 'lime'], correct: 'dime' },
      { prompt: 'pig', options: ['big', 'pig', 'peg', 'dig'], correct: 'pig' },
      { prompt: 'queen', options: ['queen', 'green', 'quick', 'keen'], correct: 'queen' },
      { prompt: 'book', options: ['back', 'book', 'buck', 'bake'], correct: 'book' },
      { prompt: 'train', options: ['grain', 'train', 'tray', 'drain'], correct: 'train' },
      { prompt: 'fish', options: ['dish', 'fish', 'finish', 'fist'], correct: 'fish' },
      { prompt: 'light', options: ['late', 'light', 'lift', 'night'], correct: 'light' }
    ];
    const TEST_LENGTH = 8;
    let questions = [];
    let currentIndex = 0;
    let errors = 0;

    function shuffle(items) {
      const arr = [...items];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function speakWord(word) { window.speechSynthesis.speak(new SpeechSynthesisUtterance(word)); }

    function renderQuestion() {
      const q = questions[currentIndex];
      const optionsHtml = shuffle(q.options)
        .map(opt => `<button class="btn btn-secondary" data-opt="${opt}">${opt}</button>`)
        .join('');
      document.getElementById('options').innerHTML = optionsHtml;
      document.getElementById('feedback').textContent = `Question ${currentIndex + 1} of ${questions.length}`;
      document.getElementById('nextButton').disabled = true;
      document.querySelectorAll('#options button').forEach(btn => {
        btn.addEventListener('click', () => checkAnswer(btn.dataset.opt));
      });
      speakWord(q.prompt);
    }

    function checkAnswer(selected) {
      const q = questions[currentIndex];
      const feedbackDiv = document.getElementById('feedback');
      if (selected === q.correct) {
        feedbackDiv.innerHTML = `<span class="correct">✅ Correct!</span>`;
      } else {
        errors++;
        feedbackDiv.innerHTML = `<span class="incorrect">❌ Incorrect. Correct answer: ${q.correct}</span>`;
      }
      document.querySelectorAll('#options button').forEach(btn => btn.disabled = true);
      document.getElementById('nextButton').disabled = false;
    }

    function goNext() {
      currentIndex++;
      if (currentIndex < questions.length) {
        renderQuestion();
      } else {
        const accuracy = ((questions.length - errors) / questions.length) * 100;
        document.getElementById('feedback').innerHTML = `<div class="alert alert-info">Test complete!<br>Accuracy: ${accuracy.toFixed(2)}%<br>Total errors: ${errors}</div>`;
        sessionStorage.setItem('phonemic_awareness_errors_score', errors);
        sessionStorage.setItem('phonemic_errors_score', errors);
        document.getElementById('options').innerHTML = '';
        document.getElementById('nextButton').style.display = 'none';
        document.getElementById('finishTestBtn').style.display = 'block';
      }
    }

    document.getElementById('speakButton').addEventListener('click', () => {
      if (currentIndex < questions.length) speakWord(questions[currentIndex].prompt);
    });
    document.getElementById('nextButton').addEventListener('click', goNext);
    document.getElementById('finishTestBtn').addEventListener('click', () => { window.location.href = '/dyslexia-prediction'; });

    document.addEventListener('DOMContentLoaded', () => {
      questions = shuffle(questionBank).slice(0, TEST_LENGTH);
      renderQuestion();
    });
  </script>
</body>
</html>
