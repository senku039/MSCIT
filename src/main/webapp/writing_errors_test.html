<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Writing Errors Test</title>
  <link rel="stylesheet" href="/theme.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: url('/IMAGES/kids.jpg') no-repeat center center/cover; }
    .container { max-width: 640px; margin-top: 50px; background: rgba(255,255,255,.95); padding: 30px; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,.18); }
    .feedback { margin-top: 20px; font-size: 1.05em; }
    .correct { color: green; }
    .incorrect { color: red; }
    .progress { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <button class="global-back-btn" type="button" onclick="window.location.href='/home'">‚Üê Back</button>
  <div class="container">
    <h1 class="text-center mb-4">Writing Errors Test</h1>
    <p class="text-muted text-center">Sentences are randomized each session.</p>
    <div class="card shadow-sm"><div class="card-body">
      <p class="lead">Listen to the sentence and type it below:</p>
      <div class="mb-3"><button id="speakButton" class="btn btn-primary">Hear the Sentence</button></div>
      <div class="mb-3"><textarea id="userInput" class="form-control" rows="4" placeholder="Type the sentence here"></textarea></div>
      <button id="checkButton" class="btn btn-success">Check Writing</button>
      <div id="feedback" class="feedback"></div>
      <div id="progress" class="progress"></div>
      <button id="finishTestBtn" class="btn btn-info w-100 mt-3" style="display: none;">Finish Test</button>
    </div></div>
  </div>

  <script>
    const sentenceBank = [
      "The quick brown fox jumps over the lazy dog.",
      "Learning every day helps children gain confidence.",
      "Reading books can improve vocabulary and focus.",
      "Practice makes writing clearer and more accurate.",
      "The little bird sang near the green tree.",
      "My teacher asked me to complete the homework today.",
      "We played football in the park after school.",
      "Healthy food gives us strength and energy.",
      "The science project was completed before the deadline.",
      "Our class visited the museum to learn local history.",
      "I organized my notebook to prepare for tomorrow's lesson.",
      "Every student should read instructions carefully before writing."
    ];
    const TEST_LENGTH = 8;
    let sentences = [];
    let currentSentenceIndex = 0;
    let totalErrors = 0;

    function shuffle(items) {
      const arr = [...items];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function speakSentence(sentence) { window.speechSynthesis.speak(new SpeechSynthesisUtterance(sentence)); }

    function normalize(text) { return text.toLowerCase().replace(/[.,!?]/g, '').replace(/\s+/g, ' ').trim(); }

    function calculateErrors(input, original) {
      const a = normalize(input).split(' ').filter(Boolean);
      const b = normalize(original).split(' ').filter(Boolean);
      let errors = Math.abs(a.length - b.length);
      const min = Math.min(a.length, b.length);
      for (let i = 0; i < min; i++) if (a[i] !== b[i]) errors++;
      return errors;
    }

    function updateProgress() { document.getElementById('progress').textContent = `Progress: ${Math.min(currentSentenceIndex, sentences.length)}/${sentences.length}`; }

    function showCurrentSentence() {
      if (currentSentenceIndex < sentences.length) {
        speakSentence(sentences[currentSentenceIndex]);
        document.getElementById('feedback').innerHTML = '';
        document.getElementById('userInput').value = '';
      } else {
        const avgErrors = totalErrors / sentences.length;
        document.getElementById('feedback').innerHTML = `<div class="alert alert-info"><strong>Test complete!</strong><br>Total errors: ${totalErrors}<br>Average errors per sentence: ${avgErrors.toFixed(2)}</div>`;
        sessionStorage.setItem('writing_errors_score', avgErrors.toFixed(2));
        document.getElementById('finishTestBtn').style.display = 'block';
        document.getElementById('checkButton').disabled = true;
      }
    }

    function checkWriting() {
      if (currentSentenceIndex >= sentences.length) return;
      const userInput = document.getElementById('userInput').value.trim();
      if (!userInput) {
        document.getElementById('feedback').innerHTML = `<span class='incorrect'>Please type the sentence before checking.</span>`;
        return;
      }

      const errors = calculateErrors(userInput, sentences[currentSentenceIndex]);
      totalErrors += errors;
      if (errors === 0) {
        document.getElementById('feedback').innerHTML = `<span class='correct'>Perfect! No writing errors.</span>`;
      } else {
        document.getElementById('feedback').innerHTML = `<span class='incorrect'>Detected ${errors} writing error(s).</span><br><small>Reference sentence: ${sentences[currentSentenceIndex]}</small>`;
      }

      currentSentenceIndex++;
      updateProgress();
      setTimeout(showCurrentSentence, 1300);
    }

    document.getElementById('speakButton').addEventListener('click', () => {
      if (currentSentenceIndex < sentences.length) speakSentence(sentences[currentSentenceIndex]);
    });
    document.getElementById('checkButton').addEventListener('click', checkWriting);
    document.getElementById('finishTestBtn').addEventListener('click', () => { window.location.href = "/dyslexia-prediction"; });

    document.addEventListener('DOMContentLoaded', () => {
      sentences = shuffle(sentenceBank).slice(0, TEST_LENGTH);
      updateProgress();
      showCurrentSentence();
    });
  </script>
</body>
</html>
